\section{Simulation}

In this section is presented the simulation of the design obtained from the previous section in Cadence.

The first step was to simulate the circuit with the transistors specifications obtained from the optimization process. Subsequently, was performed a fine-tuning of the circuit to improve the results by performing the value sweep of the most critical transistors.

The schematic of the circuit obtained in Cadence is shown in Figure \ref{fig:WL}. The final values of the transistors are shown in Table \ref{tab:WL} and the values denoted in red are the ones altered in simulation to meet the goals and constraints.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{Images/wLcircuit.png}
    \caption{Schematic of the circuit in Cadence.}
    \label{fig:WL}
\end{figure}

\begin{table}[H]
    \centering
    \caption{Transistors final dimensions}
    \begin{tabularx}{\textwidth}{>{\centering\arraybackslash}X >{\centering\arraybackslash}X >{\centering\arraybackslash} X >{\centering\arraybackslash}X}
        \toprule
        \textbf{Transistor} & \textbf{Width (W)} & \textbf{Length (L)} & \textbf{Fingers}\\
        \midrule
        $M_{B1}, \ M_{B2}, \ M_{B4}$ & \SI{2.84}{\micro\meter} & \SI{180}{\nano\meter} &  1\\
        \midrule
        $M_{B3}, \ M_{B7}$ & \SI{1.69}{\micro\meter} & \SI{180}{\nano\meter} & 1\\
        \midrule
        $M_{B5}$ & \textcolor{red}{\SI{520}{\nano\meter}} & \SI{800}{\nano\meter} & 1\\
        \midrule
        $M_{B6}$ & \textcolor{red}{\SI{740}{\nano\meter}} & \SI{600}{\nano\meter} & 1\\
        \midrule
        $M_{1a}, \ M_{2a}, \ M_{1b}, \ M_{2b}$ & \SI{9.335}{\micro\meter} & \SI{400}{\nano\meter} & \textcolor{red}{12}\\
        \midrule
        $M_{3}, \ M_{4}$ & \SI{7.745}{\micro\meter} & \SI{200}{\nano\meter} & 8\\
        \midrule
        $M_{5}, \ M_{6}$ & \SI{8.165}{\micro\meter} & \SI{800}{\nano\meter} & 4\\
        \midrule
        $M_{7a}, \ M_{8a}$ & \textcolor{red}{\SI{9.915}{\micro\meter}} & \SI{500}{\nano\meter} & \textcolor{red}{6}\\
        \midrule
        $M_{7b}, \ M_{8b}$ & \textcolor{red}{\SI{7.5}{\micro\meter}} & \SI{180}{\nano\meter} & \textcolor{red}{4}\\
        \midrule
        $M_{9}$ & \textcolor{red}{\SI{8.25}{\micro\meter}} & \SI{180}{\nano\meter} & \textcolor{red}{6}\\
        \midrule
        $M_{10}, \ M_{11}$ & \SI{8.52}{\micro\meter} & \SI{600}{\nano\meter} & 10\\
        \midrule
        $M_{12}, \ M_{13}$ & \SI{4.24}{\micro\meter} & \SI{180}{\nano\meter} & 1\\
        \bottomrule
    \end{tabularx}
    \label{tab:WL}
\end{table}


After the schematic was completed and verified, the symbol of the circuit was created to be used in the simulations. The testing circuit used for simulations is shown in Figure \ref{fig:Symbol}. The final current source used in simulations was $\SI{15}{\micro\ampere} = I_B / 10$.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{Images/tb.png}
    \caption{Symbol of the circuit in Cadence.}
    \label{fig:Symbol}
\end{figure}

\subsection{DC Simulation}

The DC simulation was performed to verify the biasing of the circuit, in Figure \ref{fig:DC} is shown the results obtained. The results were also compiled in Table \ref{tab:DC} and Table \ref{tab:DC-RFC}. All the transistors are in the moderate inversion region, except for transistors $M_{B5}$ and $M_{B6}$ that are in the weak inversion region. This is not a problem since the transistors are used as current sources and the current is not affected by the region of operation.

Observing the currents in the transistors of the main circuit, it is possible to verify that some currents are not in the desired point, denoted in red on Table \ref{tab:DC-RFC}. This is due to the fact that the transistors are not ideal, and the currents are affected by the transistors' dimensions and the biasing circuit. This fact is not a major problem since the circuit is working as expected and the currents are reasonable for the circuit to work properly, however the topology is not being used as its full potential. This could be improved by further optimization of the circuit, but for the purposes of this labwork, the results are acceptable.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{Images/OP.png}
    \caption{Schematic of the circuit in Cadence}
    \label{fig:DC}
\end{figure}

\begin{table}[H]
    \centering
    \caption{DC simulation results biasing circuit}
    \begin{tabularx}{\textwidth}{>{\centering\arraybackslash}X >{\centering\arraybackslash}X >{\centering\arraybackslash}X}
        \toprule
        \textbf{Transistor} & \textbf{$V_{DSat}$} & \textbf{$I_B$}\\
        \midrule
        $M_{B1}$ & \SI{-138.1}{\milli\volt} & \SI{-15}{\micro\ampere}\\
        \midrule
        $M_{B2}$ & \SI{-138.2}{\milli\volt} & \SI{-17.18}{\micro\ampere}\\
        \midrule
        $M_{B3}$ & \SI{120.9}{\milli\volt} & \SI{17.18}{\micro\ampere}\\
        \midrule
        $M_{B4}$ & \SI{-138.1}{\milli\volt} & \SI{-15.35}{\micro\ampere}\\
        \midrule
        $M_{B5}$ & \SI{341.7}{\milli\volt} & \SI{15.35}{\micro\ampere}\\
        \midrule
        $M_{B6}$ & \SI{-435.2}{\milli\volt} & \SI{-17.12}{\micro\ampere}\\
        \midrule
        $M_{B7}$ & \SI{120.8}{\milli\volt} & \SI{17.12}{\micro\ampere}\\
        \bottomrule
    \end{tabularx}
    \label{tab:DC}
\end{table}

\begin{table}[H]
    \centering
    \caption{DC simulation results main circuit}
    \begin{tabularx}{\textwidth}{>{\centering\arraybackslash}X >{\centering\arraybackslash}X >{\centering\arraybackslash}X}
        \toprule
        \textbf{Transistor} & \textbf{$V_{DSat}$} & \textbf{$I_D$}\\
        \midrule
        $M_{1a}$ & \SI{-67.98}{\milli\volt} & \SI{-37.8}{\micro\ampere}\\
        \midrule
        $M_{1b}$ & \SI{-67.98}{\milli\volt} & \SI{-37.99}{\micro\ampere}\\
        \midrule
        $M_{2a}$ & \SI{-67.78}{\milli\volt} & \SI{-37.45}{\micro\ampere}\\
        \midrule
        $M_{2b}$ & \SI{-67.78}{\milli\volt} & \SI{-37.55}{\micro\ampere}\\
        \midrule
        $M_{3}$ & \SI{-66.74}{\milli\volt} & \textcolor{red}{\SI{-21.61}{\micro\ampere}}\\
        \midrule
        $M_{4}$ & \SI{-107.1}{\milli\volt} & \textcolor{red}{\SI{-20.68}{\micro\ampere}}\\
        \midrule
        $M_{5}$ & \SI{70.61}{\milli\volt} & \textcolor{red}{\SI{21.61}{\micro\ampere}}\\
        \midrule
        $M_{6}$ & \SI{68.54}{\milli\volt} & \textcolor{red}{\SI{20.68}{\micro\ampere}}\\
        \midrule
        $M_{7a}$ & \SI{69.2}{\milli\volt} & \textcolor{red}{\SI{59.06}{\micro\ampere}}\\
        \midrule
        $M_{7b}$ & \SI{66.09}{\milli\volt} & \SI{37.99}{\micro\ampere}\\
        \midrule
        $M_{8a}$ & \SI{68.97}{\milli\volt} & \textcolor{red}{\SI{58.48}{\micro\ampere}}\\
        \midrule
        $M_{8b}$ & \SI{65.93}{\milli\volt} & \SI{37.55}{\micro\ampere}\\
        \midrule
        $M_{9}$ & \SI{-139}{\milli\volt} & \SI{-150.8}{\micro\ampere}\\
        \midrule
        $M_{10}$ & \SI{-69.86}{\milli\volt} & \SI{-20.68}{\micro\ampere}\\
        \midrule
        $M_{11}$ & \SI{-69.86}{\milli\volt} & \SI{-21.61}{\micro\ampere}\\
        \midrule
        $M_{12}$ & \SI{123.9}{\milli\volt} & \SI{37.55}{\micro\ampere}\\
        \midrule
        $M_{13}$ & \SI{124.3}{\milli\volt} & \SI{37.99}{\micro\ampere}\\
        \bottomrule
    \end{tabularx}
    \label{tab:DC-RFC} 
\end{table}

\subsection{AC Simulation}

The AC simulation was performed to verify the gain and bandwidth of the circuit. The bode diagram obtained is shown in Figure \ref{fig:bode}.

The results obtained are shown in Table \ref{tab:AC}, where is possible to verify that all the goals and constraints were achieved. The pole frequencies of second and third pole are lower than desirable however, with a good phase margin stability is guaranteed. These parameters could be further optimized to the DC gain or GBW, but in order to meet the labwork requirements, the values were kept as they are.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{Images/bode.png}
    \caption{Bode diagram of the circuit.}
    \label{fig:bode}
\end{figure}

\begin{table}[H]
    \centering
    \caption{AC simulation results}
    \begin{tabularx}{\textwidth}{>{\centering\arraybackslash}X >{\centering\arraybackslash}X }
        \toprule
        \textbf{Parameter} & \textbf{Result} \\
        \midrule
        DC Gain & \SI{66.8}{\decibel} \\
        \midrule
        Gain Bandwidth Product & \SI{105.4}{\mega\hertz}\\
        \midrule
        Phase Margin & \SI{41.41}{\degree}\\
        \midrule
        Output Swing & \SI{763.6}{\milli\volt}\\
        \midrule
        Power Dissipation & \SI{420}{\micro\watt}\\
        \midrule
        Excess-Noise Factor & 2.199 \\
        \midrule
        Figure of Merit & \SI{502}{\mega \hertz \cdot \pico \farad  / \milli \watt}\\
        \bottomrule
    \end{tabularx}
    \label{tab:AC}
\end{table}

\subsection{Layout}

A simplified layout of the circuit was performed to verify the area occupied by the circuit. The layout obtained is shown in Figure \ref{fig:layout}, this result is consistent with the expected area. The area occupied by the circuit is a crucial parameter in the design of integrated circuits, as it directly influences the cost of the circuit, thus a small area is always desirable.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{Images/layout.png}
    \caption{Simplified layout of the circuit.}
    \label{fig:layout}
\end{figure}

The area occupied by the circuit was approximately \SI{1.68}{\nano\meter\squared}, which is a fairly good result for this circuit.

\subsection{Improvement proposal of biasing circuit}

Given that $i_{dB3} = i_{dB5}$ and $V_{B1}$ is only used to bias $M_{B7}$, e$V_{B4}$ should be enough to bias $M_{B7}$, in order to do that, $M_{B7} = M_{B5}$. This way $M_{B2}$ and $M_{B3}$ can be removed from the circuit. To test wether this works, this modification was applied to the original circuit and tested the same why the original circuit was. The resulting biasing circuit can be viewed in Figure \ref{fig:mod-bias}.

If this modification works, it would make the circuit consume $\frac{i_B}{10}\cdot V_{DD}$ less power, and should make the circuit smaller because it has less transistors.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{Images/v3_bias.png}
    \caption{Modified biasing circuit}
    \label{fig:mod-bias}
\end{figure}

The AC and DC simulations were performed to the modified circuit, and the biasing state was maintained. Therefore, the AC simulation was analyzed and the results are shown in Table \ref{tab:AC-mod} and in the Bode diagram of Figure \ref{fig:bod-mod}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{Images/v3_bode.png}
    \caption{Bode diagram of the modified circuit}
    \label{fig:bod-mod}
\end{figure}

\begin{table}[H]
    \centering
    \caption{AC simulation results}
    \begin{tabularx}{\textwidth}{>{\centering\arraybackslash}X >{\centering\arraybackslash}X }
        \toprule
        \textbf{Parameter} & \textbf{Result} \\
        \midrule
        DC Gain & \SI{66.89}{\decibel} \\
        \midrule
        Gain Bandwidth Product & \SI{105.5}{\mega\hertz}\\
        \midrule
        Phase Margin & \SI{40.96}{\degree}\\
        \midrule
        Output Swing & \SI{764.1}{\milli\volt}\\
        \midrule
        Power Dissipation & \SI{414}{\micro\watt}\\
        \midrule
        Excess-Noise Factor & 2.196 \\
        \midrule
        Figure of Merit & \SI{509.66}{\mega \hertz \cdot \pico \farad  / \milli \watt}\\
        \bottomrule
    \end{tabularx}
    \label{tab:AC-mod}
\end{table}

The simplified layout was also performed for this circuit and the result is shown in Figure \ref{fig:area-mod}. The area occupied by the circuit was approximately \SI{1.62}{\nano\meter\squared}, which is less than the values calculated in the circuit studied.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{Images/v3_layout.png}
    \caption{Simplified layout of modified circuit}
    \label{fig:area-mod}
\end{figure}

\subsubsection{Conclusion}
For the parameters tested this modification works and even improves the $FoM$ value. Although, this does not mean that the modification should be performed. In order to evaluate wether or not to use this biasing circuit, a Power Supply Rejection Ration (PSRR) test should be perform as well as a Monte Carlo simulation. With $M_{B7}$ being biased by $M_{B5}$, could be problematic for layout, since they are not aligned in the circuit.
